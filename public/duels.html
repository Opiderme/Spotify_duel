<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Duels de Titres</title>
  <script src="https://sdk.scdn.co/spotify-player.js"></script>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <h1>Duels de Titres</h1>
  <div class="duel-container" id="duelContainer"></div>
  <input type="range" id="volumeSlider" min="0" max="100" value="50" oninput="setVolume(this.value)">
  <button class="btn" onclick="window.location.href='/ranking.html?access_token=' + accessToken">Voir le classement</button>

  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const accessToken = urlParams.get("access_token");
    let player;
    let deviceId;
    let currentDuel = null;

    window.onSpotifyWebPlaybackSDKReady = () => {
      player = new Spotify.Player({
        name: "My Web Player",
        getOAuthToken: cb => { cb(accessToken); },
        volume: 0.5
      });

      window.spotifyPlayer = player;

      player.addListener("ready", ({ device_id }) => {
        deviceId = device_id;
      });

      player.addListener("not_ready", ({ device_id }) => {
        console.log("Lecteur Spotify déconnecté", device_id);
      });

      player.connect();
    };

    async function generateDuels() {
      const res = await fetch(`/generate-duels?access_token=${accessToken}`);
      const data = await res.json();
      console.log("Musiques chargées :", data);
    }

    async function loadNextDuel() {
      const res = await fetch("/next-duel");
      const duel = await res.json();
      const container = document.getElementById("duelContainer");
      container.innerHTML = "";

      if (duel.message) {
        container.innerHTML = `<h2>${duel.message}</h2>`;
        return;
      }

      currentDuel = duel;

      ["track1", "track2"].forEach(key => {
        const track = duel[key];
        const div = document.createElement("div");
        div.className = "track";
        div.setAttribute("data-track-id", track.id);
        div.innerHTML = `
          <img src="${track.image}" alt="${track.title}">
          <h3>${track.title}</h3>
          <p>${track.artist}</p>
          <div class="progress-overlay">
            <div class="progress-bar"></div>
          </div>
        `;
        div.addEventListener("mouseenter", () => playTrack(track.id));
        div.addEventListener("mouseleave", pauseTrack);
        div.onclick = () => vote(track.id);
        container.appendChild(div);
      });
    }

    async function playTrack(trackId) {
      if (!deviceId) return;
      await fetch(`https://api.spotify.com/v1/me/player/play?device_id=${deviceId}`, {
        method: "PUT",
        headers: {
          "Authorization": `Bearer ${accessToken}`,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ uris: [`spotify:track:${trackId}`] })
      });
    }

    async function pauseTrack() {
      await fetch(`https://api.spotify.com/v1/me/player/pause?device_id=${deviceId}`, {
        method: "PUT",
        headers: {
          "Authorization": `Bearer ${accessToken}`
        }
      });
    }

    async function setVolume(volume) {
      await fetch(`https://api.spotify.com/v1/me/player/volume?volume_percent=${volume}`, {
        method: "PUT",
        headers: {
          "Authorization": `Bearer ${accessToken}`
        }
      });
    }

    async function vote(winnerId) {
      await fetch("/vote", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ winnerId, duelId: currentDuel.duelId })
      });
      loadNextDuel();
    }

    async function init() {
      await generateDuels();
      loadNextDuel();
    }

    init();
  </script>
</body>
</html>
